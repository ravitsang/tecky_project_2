<blockquote class="gs gt gu"><p id="b145" class="gv gw ed gx gy b gz ha hb hc hd he hf hg hh hi hj dv">In this article, I will use <em class="bc">Javascript</em> (<em class="bc">Node.js</em>) for the code, <em class="bc">Yarn</em> as a package manager for Node, and <em class="bc">apt-get</em> for OS dependencies.</p></blockquote><p id="b1e2" class="gv gw ed bc gy b gz ha hb hc hd he hf hg hh hi hj dv">When you need data from a source that doesn’t provide an API, you have to do web scraping. That’s why you can consider using Puppeteer combined with Google Cloud Functions. Puppeteer is a library that uses Chromium to automate browser interactions. However, this is a time-consuming process, heavy for CPU and memory. So in order to keep your app light, you may want to execute this code into a cloud environment like Google Cloud Functions (the equivalent of AWS Lambda).</p><figure class="hl hm hn ho hp hq dm dn paragraph-image"><div class="hr hs ht hu al"><div class="dm dn hk"><div class="ia r ht ib"><div class="ic r"><div class="hv hw dq t u hx al cu hy hz"><img class="dq t u hx al id ie if" src="https://miro.medium.com/max/60/1*yVVJToJSlbCH0m63Kzwf1g.png?q=20" width="1024" height="694" role="presentation"></div><img class="hv hw dq t u hx al ig" width="1024" height="694" role="presentation"><noscript><img class="dq t u hx al" src="https://miro.medium.com/max/2048/1*yVVJToJSlbCH0m63Kzwf1g.png" width="1024" height="694" role="presentation"></noscript></div></div></div></div></figure><h1 id="8b2a" class="ih ii ed bc bb ij ef ik eh il im in io ip iq ir is">Basic configuration</h1><p id="3629" class="gv gw ed bc gy b gz it hb iu hd iv hf iw hh ix hj dv">Let’s start by initializing a node project:</p><pre class="hl hm hn ho hp iy iz dc"><span id="218f" class="ja ii ed bc jb b fh jc jd r je">$ yarn init -y</span></pre><p id="c1e0" class="gv gw ed bc gy b gz ha hb hc hd he hf hg hh hi hj dv">Then, <code class="ib jf jg jh jb b">cd</code> to your new project and install Puppeteer:</p><pre class="hl hm hn ho hp iy iz dc"><span id="9f2c" class="ja ii ed bc jb b fh jc jd r je">$ yarn add puppeteer</span></pre><p id="19f1" class="gv gw ed bc gy b gz ha hb hc hd he hf hg hh hi hj dv">This will download the most recent stable version of Chromium on your machine, about ~200MB depending on your OS.</p><p id="6600" class="gv gw ed bc gy b gz ha hb hc hd he hf hg hh hi hj dv">In order to test and deploy your functions, you will need to install the Google Cloud SDK and the Google Cloud Functions Emulator. To get the SDK, run the following command (on <em class="gx">Ubuntu</em>):</p><pre class="hl hm hn ho hp iy iz dc"><span id="54e5" class="ja ii ed bc jb b fh jc jd r je">$ sudo apt-get install google-cloud-sdk</span></pre><p id="e988" class="gv gw ed bc gy b gz ha hb hc hd he hf hg hh hi hj dv">This SDK will allow you to deploy your functions. But before that, you will need to test them locally with the functions emulator:</p><pre class="hl hm hn ho hp iy iz dc"><span id="a794" class="ja ii ed bc jb b fh jc jd r je">$ yarn global add @google-cloud/functions-emulator --ignore-engines</span></pre><p id="def2" class="gv gw ed bc gy b gz ha hb hc hd he hf hg hh hi hj dv">The <code class="ib jf jg jh jb b">--ignore-engines</code> option will very likely be required. Currently, the Google Cloud Functions Emulator is fully compatible with Node 6. If your Node version is higher than that, the dependency won’t work unless you choose to ignore it with this option.</p><p id="2f62" class="gv gw ed bc gy b gz ha hb hc hd he hf hg hh hi hj dv">So basically, your project only needs two files:</p><ul class=""><li id="f57c" class="gv gw ed bc gy b gz ha hb hc hd he hf hg hh hi hj ji jj jk"><code class="ib jf jg jh jb b">index.js</code> for your Javascript code</li><li id="3737" class="gv gw ed bc gy b gz jl hb jm hd jn hf jo hh jp hj ji jj jk"><code class="ib jf jg jh jb b">package.json</code> for the Puppeteer dependency and your scripts</li></ul><p id="cc3f" class="gv gw ed bc gy b gz ha hb hc hd he hf hg hh hi hj dv">Here, <code class="ib jf jg jh jb b">package.json</code> contains the basic scripts to test your function locally and deploy it:</p><figure class="hl hm hn ho hp hq"><div class="ia r ht"><div class="jq r"><iframe src="https://medium.com/media/251b94d6b5cd4c6fb127cc26144ff755" allowfullscreen="" frameborder="0" height="0" width="0" title="" class="dq t u hx al" scrolling="auto"></iframe></div></div></figure><p id="3672" class="gv gw ed bc gy b gz ha hb hc hd he hf hg hh hi hj dv">This file contains the main dependency of this project, <code class="ib jf jg jh jb b">puppeteer</code>, and two scripts to test and deploy your function. Both scripts rely on <code class="ib jf jg jh jb b">scrapingExample</code>, the name used in the example below with <code class="ib jf jg jh jb b">exports.scrapingExample</code>.</p><ul class=""><li id="c9ed" class="gv gw ed bc gy b gz ha hb hc hd he hf hg hh hi hj ji jj jk">The <code class="ib jf jg jh jb b">deploy</code> script is used to put your function on a remote cloud environment. <code class="ib jf jg jh jb b">--trigger-http</code> associates an HTTP verb (by default POST) to our function. <code class="ib jf jg jh jb b">--runtime</code> is the runtime used here (others are available like Node 6, Go and Python). The complete list of options is available <a href="https://cloud.google.com/sdk/gcloud/reference/functions/deploy" class="fn ch jr js jt ju" target="_blank" rel="noopener nofollow">here</a>.</li><li id="a83a" class="gv gw ed bc gy b gz jl hb jm hd jn hf jo hh jp hj ji jj jk">The <code class="ib jf jg jh jb b">start</code> script launches the functions emulator and locally deploys the function with the same <code class="ib jf jg jh jb b">--trigger-http</code> flag described above.</li></ul><p id="83c0" class="gv gw ed bc gy b gz ha hb hc hd he hf hg hh hi hj dv">The following code is a basic configuration for <code class="ib jf jg jh jb b">index.js</code>:</p><figure class="hl hm hn ho hp hq"><div class="ia r ht"><div class="jq r"><iframe src="https://medium.com/media/a534ed45ae972a46f9b63b0f79b9fc33" allowfullscreen="" frameborder="0" height="0" width="0" title="" class="dq t u hx al" scrolling="auto"></iframe></div></div></figure><p id="537e" class="gv gw ed bc gy b gz ha hb hc hd he hf hg hh hi hj dv">There is a lot of boilerplate here: the only important lines are lines 38-41! However, we’ll go through the rest of the code to understand what happens.</p><p id="ff25" class="gv gw ed bc gy b gz ha hb hc hd he hf hg hh hi hj dv">First, we import <code class="ib jf jg jh jb b">puppeteer</code> and declare its options:</p><ul class=""><li id="e090" class="gv gw ed bc gy b gz ha hb hc hd he hf hg hh hi hj ji jj jk"><code class="ib jf jg jh jb b">headless</code> is one of the most important options. When you test your function locally, put it to <code class="ib jf jg jh jb b">false</code> to see what happens in your browser. Every action of your script will be visible. Nevertheless,<strong class="gy jv"> you must put it to </strong><code class="ib jf jg jh jb b"><strong class="gy jv">true</strong></code><strong class="gy jv"> before deploying it to Google Cloud Functions</strong>. Otherwise, the execution will crash because the service cannot execute the GUI of Chromium.</li><li id="40af" class="gv gw ed bc gy b gz jl hb jm hd jn hf jo hh jp hj ji jj jk"><code class="ib jf jg jh jb b">args</code> contains a list of useful options. Some of them are pretty explicit like <code class="ib jf jg jh jb b">--disable-gpu</code> or <code class="ib jf jg jh jb b">--timeout=30000</code> and some others like<code class="ib jf jg jh jb b">--no-sandbox</code> are here to prevent crashes in some environments. The complete list of arguments can be found <a href="https://peter.sh/experiments/chromium-command-line-switches/" class="fn ch jr js jt ju" target="_blank" rel="noopener nofollow">here</a>.</li></ul><p id="451a" class="gv gw ed bc gy b gz ha hb hc hd he hf hg hh hi hj dv">Then finally comes the code, split into 3 functions:</p><ul class=""><li id="6faa" class="gv gw ed bc gy b gz ha hb hc hd he hf hg hh hi hj ji jj jk"><code class="ib jf jg jh jb b">openConnection</code> initializes all the necessary objects to browse with Puppeteer. It also sets a few parameters like the user agent and the viewport, necessary for some websites.</li><li id="22e8" class="gv gw ed bc gy b gz jl hb jm hd jn hf jo hh jp hj ji jj jk"><code class="ib jf jg jh jb b">closeConnection</code> destroys the objects initialized before and must be called at the end of every execution, regardless of the results of the execution. I’ll explain why in the <em class="gx">Tips and tricks </em>section.</li><li id="50f9" class="gv gw ed bc gy b gz jl hb jm hd jn hf jo hh jp hj ji jj jk"><code class="ib jf jg jh jb b">scrapingExample</code> is the main function, which is going to be called by the functions emulator and deployed in Google Cloud. The <code class="ib jf jg jh jb b">exports.</code> before the function name makes it available for Google Cloud Functions. In order to keep this example simple, it only does a simple thing: go to the Medium homepage, get its first article title, and return it.</li></ul><h1 id="682c" class="ih ii ed bc bb ij ef ik eh il im in io ip iq ir is">Interactions with Google Cloud Storage</h1><p id="fc7e" class="gv gw ed bc gy b gz it hb iu hd iv hf iw hh ix hj dv">At some point, you may need to have persistent data. To do that, you cannot use the execution environment of your Google Cloud Function. A storage in fact exists, but it is temporary and very limited. To store a large number of files, you can use a cloud storage service like Google Cloud Storage or AWS S3. Just know that with the Google Cloud’s Free Plan, <strong class="gy jv">you cannot send data to another IP, so in this case, forget about Amazon S3, and go for Google Cloud Storage.</strong></p><p id="2278" class="gv gw ed bc gy b gz ha hb hc hd he hf hg hh hi hj dv">There are several ways to upload files to a cloud storage. The most elegant one (not always possible), is to download your file (through <em class="gx">axios</em> for example), and pipe it to your remote bucket. This way, you never store anything in your Cloud Function environment, and avoid a lot of potential problems, like available storage or file naming. You can see an example of this method <a href="https://stackoverflow.com/questions/44945376/how-to-upload-an-in-memory-file-data-to-google-cloud-storage-using-nodejs?rq=1" class="fn ch jr js jt ju" target="_blank" rel="noopener nofollow">here</a>.</p><p id="7deb" class="gv gw ed bc gy b gz ha hb hc hd he hf hg hh hi hj dv">But sometimes, piping directly is not possible so you need to store your files in a temporary directory before uploading them. There is a simple way to initialize and use Google Cloud Storage with Puppeteer:</p><figure class="hl hm hn ho hp hq"><div class="ia r ht"><div class="jq r"><iframe src="https://medium.com/media/3bb91d5d6a0032bc3b9fe2c11da4a2a3" allowfullscreen="" frameborder="0" height="0" width="0" title="" class="dq t u hx al" scrolling="auto"></iframe></div></div></figure><p id="2d99" class="gv gw ed bc gy b gz ha hb hc hd he hf hg hh hi hj dv">Here, we do several things:</p><ol class=""><li id="24f2" class="gv gw ed bc gy b gz ha hb hc hd he hf hg hh hi hj jw jj jk">We import Puppeteer and Google Cloud Storage.</li><li id="6ae6" class="gv gw ed bc gy b gz jl hb jm hd jn hf jo hh jp hj jw jj jk">We initialize our bucket and Puppeteer.</li><li id="9bc3" class="gv gw ed bc gy b gz jl hb jm hd jn hf jo hh jp hj jw jj jk">We allow Puppeteer to download files and we define the storage location. In the context of a Google Cloud Function, you would only be able to write in the <code class="ib jf jg jh jb b">/tmp/</code> directory.</li><li id="c973" class="gv gw ed bc gy b gz jl hb jm hd jn hf jo hh jp hj jw jj jk">We scrape our file: Puppeteer goes to the page, clicks the link (which will download the file to <code class="ib jf jg jh jb b">/tmp/</code>) and upload it to Google Cloud Storage.</li></ol><h1 id="1d29" class="ih ii ed bc bb ij ef ik eh il im in io ip iq ir is">Handling bad website design</h1><p id="2748" class="gv gw ed bc gy b gz it hb iu hd iv hf iw hh ix hj dv">As a programmer, it’s a common thing to say it’s someone else’s fault. And when you do web scraping… this may be true! In fact, a website can be very poorly designed at several levels, making it difficult to scrape.</p><figure class="hl hm hn ho hp hq dm dn paragraph-image"><div class="hr hs ht hu al"><div class="dm dn jx"><div class="ia r ht ib"><div class="jy r"><div class="hv hw dq t u hx al cu hy hz"><img class="dq t u hx al id ie if" src="https://miro.medium.com/max/46/1*gXq-DCVPmArBK1qHtawTqQ.jpeg?q=20" width="914" height="1200" role="presentation"></div><img class="hv hw dq t u hx al ig" width="914" height="1200" role="presentation"><noscript><img class="dq t u hx al" src="https://miro.medium.com/max/1828/1*gXq-DCVPmArBK1qHtawTqQ.jpeg" width="914" height="1200" role="presentation"></noscript></div></div></div></div></figure><p id="1dc1" class="gv gw ed bc gy b gz ha hb hc hd he hf hg hh hi hj dv">One problem you may encounter is related to page loading. Puppeteer provides several functions to wait for events. For example, if you need to navigate to a page and get an element from it, you can use the following function: <code class="ib jf jg jh jb b">await page.waitForNavigation({ waitUntil: 'load' })</code>. However, bad website design can make this instruction crash if you try to get an unexisting HTML element on the new page. Some websites trigger the <code class="ib jf jg jh jb b">load</code> event when the new page is loaded, but it only contains a loader element. You have to be careful, and it’s sometimes preferable to use <code class="ib jf jg jh jb b">await page.waitForSelector('.mySelector')</code>. The good thing about these two functions is that they have an optional <code class="ib jf jg jh jb b">timeout</code> argument. This can be useful on websites with a long loading time: the default timeout is 500ms.</p><p id="9a66" class="gv gw ed bc gy b gz ha hb hc hd he hf hg hh hi hj dv">You also need to be careful with navigation links. Sometimes the information you want to scrape won’t be on a page directly accessible by URL. Some websites load data as you navigate, and you may need to reproduce a full “human” browsing to get the information you need.</p><p id="2a9e" class="gv gw ed bc gy b gz ha hb hc hd he hf hg hh hi hj dv">Finally, be very precise with your CSS selectors! Some websites use the same id on several elements. This can make you select the wrong element in your code. When possible, use the <code class="ib jf jg jh jb b">&gt;</code> selector (or other selectors) to prevent any ambiguity.</p><h1 id="ed00" class="ih ii ed bc bb ij ef ik eh il im in io ip iq ir is">Tips and tricks</h1><h2 id="e9f7" class="ja ii ed bc bb ij jz ka kb kc kd ke kf kg kh ki kj">Memory management</h2><p id="2c51" class="gv gw ed bc gy b gz it hb iu hd iv hf iw hh ix hj dv">Your Google Cloud Function can run out of memory if you are not careful. Puppeteer launches Chromium, and you need to instantiate big objects (like <code class="ib jf jg jh jb b">browser</code> or <code class="ib jf jg jh jb b">page</code>) to use it. In the example above titled <em class="gx">Basic configuration</em>, you can see that <code class="ib jf jg jh jb b">closeConnection</code> is called in the <code class="ib jf jg jh jb b">finally</code> block. This is to destroy the objects and clean up the memory as you exit the function. In many Puppeteer examples, you don’t destroy anything in case of error. After several executions, your environment memory can then become full, and the first instruction <code class="ib jf jg jh jb b">puppeteer.launch(PUPPETEER_OPTIONS)</code> will crash.</p><h2 id="9984" class="ja ii ed bc bb ij jz ka kb kc kd ke kf kg kh ki kj">Debugging</h2><p id="5b44" class="gv gw ed bc gy b gz it hb iu hd iv hf iw hh ix hj dv">In the Google Cloud Management Console, you have access to logs that give you information about the remote execution of your functions. But for your local logs, you can use:</p><pre class="hl hm hn ho hp iy iz dc"><span id="fce3" class="ja ii ed bc jb b fh jc jd r je">$ functions logs read</span></pre><p id="58ed" class="gv gw ed bc gy b gz ha hb hc hd he hf hg hh hi hj dv">To clear them, just execute (<code class="ib jf jg jh jb b">sudo</code> may be required here):</p><pre class="hl hm hn ho hp iy iz dc"><span id="6469" class="ja ii ed bc jb b fh jc jd r je">$ functions logs clear</span></pre><h2 id="1bfa" class="ja ii ed bc bb ij jz ka kb kc kd ke kf kg kh ki kj">DOM interactions</h2><p id="8967" class="gv gw ed bc gy b gz it hb iu hd iv hf iw hh ix hj dv">In order to get information on DOM elements, you can use the Puppeteer function <code class="ib jf jg jh jb b">page.evaluate()</code>. Inside its callback, you have access to DOM elements (through CSS selectors for example), but the rest of your code is not accessible. As a second argument after the callback, you can pass it a serializable object. This means that <strong class="gy jv">a function defined outside </strong><code class="ib jf jg jh jb b"><strong class="gy jv">evaluate()</strong></code><strong class="gy jv"> cannot be used inside of it.</strong></p><p id="b002" class="gv gw ed bc gy b gz ha hb hc hd he hf hg hh hi hj dv">Another problem with <code class="ib jf jg jh jb b">page.evaluate()</code> is that it’s hard to debug. In fact, if you try to use <code class="ib jf jg jh jb b">console.log</code> inside of it, you won’t see anything in your local logs. To solve this issue, add the following instruction just after you initialize the <code class="ib jf jg jh jb b">page</code> object:</p><pre class="hl hm hn ho hp iy iz dc"><span id="a65f" class="ja ii ed bc jb b fh jc jd r je">await page.on(‘console’, obj =&gt; console.log(obj.text()));</span></pre><h2 id="a58f" class="ja ii ed bc bb ij jz ka kb kc kd ke kf kg kh ki kj">Using headless</h2><p id="bffd" class="gv gw ed bc gy b gz it hb iu hd iv hf iw hh ix hj dv">When you test your function locally, you almost always put the <code class="ib jf jg jh jb b">headless</code> option to <code class="ib jf jg jh jb b">false</code> to see what happens in your browser. But when you deploy your function, you want the <code class="ib jf jg jh jb b">headless</code> option to be set to <code class="ib jf jg jh jb b">true</code> (otherwise it won’t work). So here is the perfect place to use an environment variable as the value of <code class="ib jf jg jh jb b">headless</code>.</p><h2 id="66a2" class="ja ii ed bc bb ij jz ka kb kc kd ke kf kg kh ki kj">Optimization</h2><p id="3331" class="gv gw ed bc gy b gz it hb iu hd iv hf iw hh ix hj dv">Finally, a very easy way to reduce the execution time of your cloud function is to parallelize text inputs in forms. If you have forms to fill, instead of doing several <code class="ib jf jg jh jb b">await page.type('.selector', fieldValue)</code>, parallelize them in a <code class="ib jf jg jh jb b">Promise.all</code>. Of course, the submitting of the form must be done outside of this <code class="ib jf jg jh jb b">Promise.all</code> to have valid field values.</p><h1 id="ab8b" class="ih ii ed bc bb ij ef ik eh il im in io ip iq ir is">Sources</h1><ul class=""><li id="00ca" class="gv gw ed bc gy b gz it hb iu hd iv hf iw hh ix hj ji jj jk"><a href="https://pptr.dev/" class="fn ch jr js jt ju" target="_blank" rel="noopener nofollow">Puppeteer documentation</a></li><li id="bb39" class="gv gw ed bc gy b gz jl hb jm hd jn hf jo hh jp hj ji jj jk"><a href="https://cloud.google.com/sdk/docs/" class="fn ch jr js jt ju" target="_blank" rel="noopener nofollow">Google Cloud SDK documentation</a></li><li id="094e" class="gv gw ed bc gy b gz jl hb jm hd jn hf jo hh jp hj ji jj jk"><a href="https://cloud.google.com/functions/docs/quickstart" class="fn ch jr js jt ju" target="_blank" rel="noopener nofollow">Google Cloud Functions Quickstart</a></li><li id="5fab" class="gv gw ed bc gy b gz jl hb jm hd jn hf jo hh jp hj ji jj jk"><a href="https://github.com/GoogleChrome/puppeteer/issues" class="fn ch jr js jt ju" target="_blank" rel="noopener nofollow">Github Puppeteer issues</a>: sometimes better than the documentation!</li><li id="46f4" class="gv gw ed bc gy b gz jl hb jm hd jn hf jo hh jp hj ji jj jk"><a href="https://code.tutsplus.com/tutorials/the-30-css-selectors-you-must-memorize--net-16048" class="fn ch jr js jt ju" target="_blank" rel="noopener nofollow">A list of 30 useful CSS selectors</a>, good to have precise DOM selectors</li><li id="70a7" class="gv gw ed bc gy b gz jl hb jm hd jn hf jo hh jp hj ji jj jk"><a href="https://yarnpkg.com/en/docs/install" class="fn ch jr js jt ju" target="_blank" rel="noopener nofollow">Yarn documentation</a></li><li id="95a9" class="gv gw ed bc gy b gz jl hb jm hd jn hf jo hh jp hj ji jj jk"><a href="https://nodejs.org/dist/latest-v11.x/docs/api/" class="fn ch jr js jt ju" target="_blank" rel="noopener nofollow">Node documentation</a></li><li id="4787" class="gv gw ed bc gy b gz jl hb jm hd jn hf jo hh jp hj ji jj jk">Two other great articles about the Puppeteer and Google Cloud Functions : <a href="https://rominirani.com/using-puppeteer-in-google-cloud-functions-809a14856e14" class="fn ch jr js jt ju" target="_blank" rel="noopener nofollow">here</a> and <a class="fn ch jr js jt ju" target="_blank" rel="noopener" href="/@ebidel/puppeteering-in-firebase-google-cloud-functions-76145c7662bd">here</a></li><li id="eb2c" class="gv gw ed bc gy b gz jl hb jm hd jn hf jo hh jp hj ji jj jk"><a href="https://gist.github.com/Alezco" class="fn ch jr js jt ju" target="_blank" rel="noopener nofollow">My personal gist</a>, containing the code examples of this article</li></ul><p id="1902" class="gv gw ed bc gy b gz ha hb hc hd he hf hg hh hi hj dv">I hope you found this article useful! Feel free to give me your feedback and ask any questions :)</p>